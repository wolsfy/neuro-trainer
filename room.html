<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ö–æ–º–Ω–∞—Ç–∞ –ù–µ–π—Ä–æ–Ω–∞</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/robot-animations.css" />
  <link rel="stylesheet" href="css/mobile.css?v=6" />
  
  <!-- model-viewer -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

  <style>
    body { 
      overflow: hidden !important;
      margin: 0;
      padding: 0;
    }
    
    .btn-back {
      font-size: 1.5rem;
      text-decoration: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      transition: all 0.2s;
      z-index: 100;
    }
    
    .btn-back:active {
      transform: scale(0.9);
      background: rgba(255,255,255,0.2);
    }

    .room-screen {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 80px;
      overflow: hidden;
    }

    .room-view {
      width: 100%;
      height: 100%;
      position: relative;
      background:
        linear-gradient(180deg, #c9def5 0%, #dbe7ff 45%, #e9edf5 45%, #f5f5f5 100%);
      overflow: hidden;
      transform-style: preserve-3d;
      contain: layout style paint;
      isolation: isolate;
    }

    .room-view::after {
      content: '';
      position: absolute;
      bottom: -10%;
      left: 50%;
      transform: translateX(-50%) rotateX(60deg);
      width: 140%;
      height: 60%;
      background:
        linear-gradient(90deg, rgba(0,0,0,0.08) 1px, transparent 1px),
        linear-gradient(0deg, rgba(0,0,0,0.06) 1px, transparent 1px);
      background-size: 60px 60px;
      background-color: #e0d4c5;
      opacity: 0.8;
      z-index: 1;
    }

    .robot-status {
      position: absolute;
      top: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 20;
    }

    .status-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .robot-avatar {
      font-size: 2rem;
    }

    .robot-name {
      flex: 1;
    }

    .robot-name-text {
      font-weight: bold;
      font-size: 1.1rem;
      color: #333;
      margin: 0;
    }

    .robot-level {
      font-size: 0.8rem;
      color: #666;
      margin: 2px 0 0 0;
    }

    .status-bars {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-icon {
      font-size: 1.3rem;
      min-width: 24px;
      text-align: center;
    }

    .status-bar-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .status-label {
      font-size: 0.75rem;
      color: #666;
      font-weight: 600;
    }

    .status-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .status-bar-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease, background 0.3s;
      position: relative;
      overflow: hidden;
      will-change: transform;
      transform: translateZ(0);
    }

    .status-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255,255,255,0.3),
        transparent
      );
      animation: shimmer 2s infinite;
      will-change: transform;
      transform: translateZ(0);
    }

    body.page-hidden .status-bar-fill::after {
      animation-play-state: paused;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .status-bar-fill.mood {
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
    }

    .status-bar-fill.energy {
      background: linear-gradient(90deg, #2196F3, #03A9F4);
    }

    .status-bar-fill.hunger {
      background: linear-gradient(90deg, #FF9800, #FFC107);
    }

    .status-bar-fill.low {
      background: linear-gradient(90deg, #f44336, #FF5722) !important;
    }

    .status-value {
      font-size: 0.7rem;
      color: #999;
      font-weight: bold;
      min-width: 35px;
      text-align: right;
    }

    .window-container {
      position: absolute;
      top: 60px;
      right: 40px;
      width: 180px;
      height: 200px;
      background: linear-gradient(180deg, #87CEEB 0%, #B0D8F0 100%);
      border-radius: 12px;
      border: 8px solid #8B7355;
      box-shadow: 
        inset 0 0 20px rgba(0,0,0,0.1),
        0 10px 30px rgba(0,0,0,0.3);
      overflow: hidden;
      z-index: 2;
    }

    .window-frame {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .window-cross-vertical {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 100%;
      background: #6B5644;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .window-cross-horizontal {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 6px;
      background: #6B5644;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .window-sky {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .cloud {
      position: absolute;
      background: white;
      border-radius: 50px;
      opacity: 0.9;
      animation: cloudFloat 20s linear infinite;
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    body.page-hidden .cloud {
      animation-play-state: paused;
    }

    .cloud::before,
    .cloud::after {
      content: '';
      position: absolute;
      background: white;
      border-radius: 50%;
    }

    .cloud-1 {
      width: 40px;
      height: 15px;
      top: 30%;
      left: -60px;
    }

    .cloud-1::before {
      width: 20px;
      height: 20px;
      top: -8px;
      left: 8px;
    }

    .cloud-1::after {
      width: 25px;
      height: 18px;
      top: -6px;
      right: 8px;
    }

    .cloud-2 {
      width: 35px;
      height: 12px;
      top: 60%;
      left: -50px;
      animation-delay: 8s;
      animation-duration: 25s;
    }

    .cloud-2::before {
      width: 18px;
      height: 18px;
      top: -7px;
      left: 6px;
    }

    .cloud-2::after {
      width: 22px;
      height: 15px;
      top: -5px;
      right: 6px;
    }

    .cloud-3 {
      width: 30px;
      height: 10px;
      top: 45%;
      left: -40px;
      animation-delay: 15s;
      animation-duration: 30s;
    }

    .cloud-3::before {
      width: 15px;
      height: 15px;
      top: -6px;
      left: 5px;
    }

    .cloud-3::after {
      width: 18px;
      height: 12px;
      top: -4px;
      right: 5px;
    }

    @keyframes cloudFloat {
      from { transform: translateX(0); }
      to { transform: translateX(250px); }
    }

    .sun {
      position: absolute;
      top: 20px;
      right: 25px;
      width: 35px;
      height: 35px;
      background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      animation: sunGlow 3s ease-in-out infinite;
      will-change: opacity;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    body.page-hidden .sun {
      animation-play-state: paused;
    }

    @keyframes sunGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
      50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.9); }
    }

    .wall-decor {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 45%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 60px 60px 0;
      z-index: 3;
      pointer-events: none;
    }

    .decor-item {
      font-size: 5rem;
      filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3));
      animation: float 3s ease-in-out infinite;
      transition: transform 0.3s ease;
      pointer-events: auto;
      cursor: pointer;
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    body.page-hidden .decor-item {
      animation-play-state: paused;
    }

    .decor-item:hover {
      transform: translateY(-8px) scale(1.08) translateZ(0);
    }

    .decor-item:nth-child(1) { animation-delay: 0s; }
    .decor-item:nth-child(2) { animation-delay: 0.5s; }
    .decor-item:nth-child(3) { animation-delay: 1s; }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateZ(0); }
      50% { transform: translateY(-15px) translateZ(0); }
    }

    .floor-items {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30%;
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      padding: 0 50px 40px;
      z-index: 5;
      pointer-events: none;
    }

    .furniture-item {
      font-size: 6rem;
      filter: drop-shadow(0 15px 25px rgba(0,0,0,0.4));
      animation: bounce 2.5s ease-in-out infinite;
      transition: transform 0.3s ease;
      pointer-events: auto;
      cursor: pointer;
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    body.page-hidden .furniture-item {
      animation-play-state: paused;
    }

    .furniture-item:hover {
      transform: translateY(-6px) scale(1.05) translateZ(0);
    }

    .furniture-item:nth-child(1) { animation-delay: 0s; }
    .furniture-item:nth-child(2) { animation-delay: 0.4s; }
    .furniture-item:nth-child(3) { animation-delay: 0.8s; }

    @keyframes bounce {
      0%, 100% { transform: translateY(0) translateZ(0); }
      50% { transform: translateY(-8px) translateZ(0); }
    }

    .robot-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateZ(0);
      z-index: 10;
      width: 350px;
      height: 400px;
      contain: layout paint;
    }

    model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: transparent;
    }

    model-viewer::part(default-progress-bar) {
      background: var(--primary);
    }

    .thought-bubble {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%) scale(0) translateZ(0);
      background: white;
      padding: 12px 20px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-weight: bold;
      color: #444;
      font-size: 1rem;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 20;
      will-change: transform, opacity;
      backface-visibility: hidden;
    }

    .thought-bubble::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid white;
    }

    .thought-bubble.show {
      opacity: 1;
      transform: translateX(-50%) scale(1) translateZ(0);
    }

    .particle {
      position: absolute;
      font-size: 1.5rem;
      pointer-events: none;
      z-index: 20;
      animation: particleFloat 2s ease-out forwards;
      will-change: transform, opacity;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    @keyframes particleFloat {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1) translateZ(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-100px) scale(1.5) translateZ(0);
      }
    }

    .particle.side {
      animation: particleSide 2s ease-out forwards;
    }

    @keyframes particleSide {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(1) translateZ(0);
      }
      100% {
        opacity: 0;
        transform: translate(var(--x), -80px) scale(1.2) translateZ(0);
      }
    }

    .room-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 12px;
      background: white;
      border-top: 2px solid #f0f0f0;
      z-index: 100;
      height: 80px;
      box-sizing: border-box;
    }

    .room-btn {
      background: var(--card-bg);
      border: none;
      padding: 10px 8px;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--text);
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .room-btn:active { 
      transform: scale(0.95);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .btn-icon { font-size: 1.6rem; }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: flex-end;
      z-index: 1000;
      animation: fadeIn 0.3s;
    }

    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      width: 100%;
      max-height: 75vh;
      border-radius: 25px 25px 0 0;
      padding: 20px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
      animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      overflow-y: auto;
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    @keyframes slideUp {
      from { transform: translateY(100%) translateZ(0); }
      to { transform: translateY(0) translateZ(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #333;
    }

    .modal-close {
      font-size: 1.8rem;
      background: none;
      border: none;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .modal-close:active {
      background: #f0f0f0;
    }

    .category-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .category-tab {
      flex: 1;
      padding: 10px 16px;
      background: #f0f0f0;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.9rem;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-tab.active {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }

    .decor-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding-bottom: 20px;
    }

    .decor-card {
      background: #f8f9fa;
      border: 3px solid #e0e0e0;
      border-radius: 16px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .decor-card:active {
      transform: scale(0.95);
    }

    .decor-card.owned {
      border-color: var(--primary);
      background: #e3f2fd;
    }

    .decor-card.equipped {
      border-color: var(--accent);
      background: #fff3e0;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.3);
    }

    .decor-icon {
      font-size: 3rem;
      margin-bottom: 8px;
    }

    .decor-name {
      font-weight: bold;
      color: #333;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .decor-status {
      color: #666;
      font-size: 0.8rem;
      margin-top: 4px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body>
  <div class="top-bar">
    <a href="index.html" class="btn-back">‚Üê</a>
    <div class="game-info">üè† –ö–æ–º–Ω–∞—Ç–∞</div>
    <div class="balance-badge">
      <span id="coins">0</span> üí∞
    </div>
  </div>

  <div class="room-screen">
    <div class="room-view">
      <div class="robot-status">
        <div class="status-header">
          <div class="robot-avatar">ü§ñ</div>
          <div class="robot-name">
            <p class="robot-name-text">–ù–µ–π—Ä–æ–Ω</p>
            <p class="robot-level">–£—Ä–æ–≤–µ–Ω—å <span id="robot-level">1</span></p>
          </div>
        </div>
        <div class="status-bars">
          <div class="status-item">
            <div class="status-icon" id="mood-icon">üòä</div>
            <div class="status-bar-container">
              <div class="status-label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
              <div class="status-bar">
                <div class="status-bar-fill mood" id="mood-bar" style="width: 80%"></div>
              </div>
            </div>
            <div class="status-value" id="mood-value">80%</div>
          </div>
          <div class="status-item">
            <div class="status-icon">üîã</div>
            <div class="status-bar-container">
              <div class="status-label">–≠–Ω–µ—Ä–≥–∏—è</div>
              <div class="status-bar">
                <div class="status-bar-fill energy" id="energy-bar" style="width: 70%"></div>
              </div>
            </div>
            <div class="status-value" id="energy-value">70%</div>
          </div>
          <div class="status-item">
            <div class="status-icon">üçî</div>
            <div class="status-bar-container">
              <div class="status-label">–ì–æ–ª–æ–¥</div>
              <div class="status-bar">
                <div class="status-bar-fill hunger" id="hunger-bar" style="width: 60%"></div>
              </div>
            </div>
            <div class="status-value" id="hunger-value">60%</div>
          </div>
        </div>
      </div>

      <div class="window-container">
        <div class="window-sky">
          <div class="sun"></div>
          <div class="cloud cloud-1"></div>
          <div class="cloud cloud-2"></div>
          <div class="cloud cloud-3"></div>
        </div>
        <div class="window-frame">
          <div class="window-cross-vertical"></div>
          <div class="window-cross-horizontal"></div>
        </div>
      </div>

      <div class="wall-decor" id="wall-decor"></div>

      <div class="robot-container" id="robot-container">
        <div class="thought-bubble" id="bubble">–ü—Ä–∏–≤–µ—Ç! üëã</div>
        <!-- TEMP: Using CDN for original model to avoid deployment timeout -->
        <model-viewer
          id="robot-model"
          src="https://raw.githubusercontent.com/wolsfy/neuro-trainer/main/cute%20robot%203d%20model.glb"
          alt="–ù–µ–π—Ä–æ–Ω - –º–∏–ª—ã–π —Ä–æ–±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫"
          camera-controls
          touch-action="pan-y"
          shadow-intensity="0"
          environment-image="neutral"
          exposure="1.0"
          camera-orbit="0deg 85deg 3.5m"
          field-of-view="25deg"
          disable-zoom
          disable-tap
          interpolation-decay="150"
          ar-modes="webxr scene-viewer quick-look"
        >
        </model-viewer>
      </div>

      <div class="floor-items" id="floor-items"></div>
    </div>
  </div>

  <div class="room-controls">
    <button class="room-btn" onclick="openDecorShop()">
      <span class="btn-icon">üé®</span>
      <span>–î–µ–∫–æ—Ä</span>
    </button>
    <button class="room-btn" onclick="window.location.href='shop.html'">
      <span class="btn-icon">üëï</span>
      <span>–û–¥–µ–∂–¥–∞</span>
    </button>
    <button class="room-btn" onclick="feedRobot()">
      <span class="btn-icon">‚ö°</span>
      <span>–ü–æ–∫–æ—Ä–º–∏—Ç—å</span>
    </button>
  </div>

  <div class="modal-overlay" id="modal" onclick="closeModalOnOverlay(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">üé® –ú–∞–≥–∞–∑–∏–Ω –¥–µ–∫–æ—Ä–∞</div>
        <button class="modal-close" onclick="closeDecorShop()">√ó</button>
      </div>
      <div class="category-tabs">
        <button class="category-tab active" onclick="showCategory('wall')">üñºÔ∏è –°—Ç–µ–Ω—ã</button>
        <button class="category-tab" onclick="showCategory('floor')">üìö –ú–µ–±–µ–ª—å</button>
      </div>
      <div class="decor-grid" id="decor-grid"></div>
    </div>
  </div>

  <script>
    function throttle(func, delay) {
      let lastCall = 0;
      return function(...args) {
        const now = Date.now();
        if (now - lastCall >= delay) {
          lastCall = now;
          return func.apply(this, args);
        }
      };
    }

    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function rafThrottle(func) {
      let rafId = null;
      return function(...args) {
        if (rafId === null) {
          rafId = requestAnimationFrame(() => {
            func.apply(this, args);
            rafId = null;
          });
        }
      };
    }

    let isPageVisible = true;

    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;
      
      if (document.hidden) {
        console.log('‚è∏Ô∏è Page hidden - pausing animations');
        document.body.classList.add('page-hidden');
        if (window.statusInterval) {
          clearInterval(window.statusInterval);
        }
      } else {
        console.log('‚ñ∂Ô∏è Page visible - resuming animations');
        document.body.classList.remove('page-hidden');
        startStatusDegradation();
      }
    });

    const decorItems = {
      wall: [
        { id: 'poster-star', icon: '‚≠ê', name: '–ó–≤–µ–∑–¥–∞', price: 0 },
        { id: 'poster-brain', icon: 'üß†', name: '–ú–æ–∑–≥', price: 50 },
        { id: 'poster-rocket', icon: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', price: 100 },
        { id: 'poster-trophy', icon: 'üèÜ', name: '–ö—É–±–æ–∫', price: 150 },
        { id: 'poster-books', icon: 'üìö', name: '–ö–Ω–∏–≥–∏', price: 80 },
        { id: 'poster-bulb', icon: 'üí°', name: '–õ–∞–º–ø–æ—á–∫–∞', price: 120 },
      ],
      floor: [
        { id: 'furniture-plant', icon: 'üåø', name: '–†–∞—Å—Ç–µ–Ω–∏–µ', price: 0 },
        { id: 'furniture-sofa', icon: 'üõå', name: '–ö—Ä–æ–≤–∞—Ç—å', price: 200 },
        { id: 'furniture-desk', icon: 'üíª', name: '–ù–æ—É—Ç–±—É–∫', price: 300 },
        { id: 'furniture-bookshelf', icon: 'üìö', name: '–ö–Ω–∏–≥–∏', price: 250 },
      ]
    };

    let coins = parseInt(localStorage.getItem('neuroCoins')) || 0;
    let ownedDecor = JSON.parse(localStorage.getItem('ownedDecor')) || ['poster-star', 'furniture-plant'];
    let equippedDecor = JSON.parse(localStorage.getItem('equippedDecor')) || {
      wall: ['poster-star'],
      floor: ['furniture-plant']
    };
    let currentCategory = 'wall';

    let robotStatus = {
      mood: parseInt(localStorage.getItem('robotMood')) || 80,
      energy: parseInt(localStorage.getItem('robotEnergy')) || 70,
      hunger: parseInt(localStorage.getItem('robotHunger')) || 60,
      level: parseInt(localStorage.getItem('robotLevel')) || 1,
      lastVisit: parseInt(localStorage.getItem('robotLastVisit')) || Date.now()
    };

    let updateQueue = [];

    function queueStatusUpdate(type, value) {
      updateQueue.push({ type, value });
    }

    function flushUpdates() {
      if (updateQueue.length === 0) return;
      if (!isPageVisible) return;
      
      updateQueue.forEach(({ type, value }) => {
        robotStatus[type] = value;
      });
      
      updateStatusBarsThrottled();
      saveDataDebounced();
      
      updateQueue = [];
    }

    function updateRobotEmotion() {
      const moodIcon = document.getElementById('mood-icon');
      
      if (robotStatus.energy < 20) {
        moodIcon.textContent = 'üò¥';
      } else if (robotStatus.mood > 80) {
        moodIcon.textContent = 'üòä';
      } else if (robotStatus.mood < 30) {
        moodIcon.textContent = 'üòû';
      } else if (robotStatus.hunger < 25) {
        moodIcon.textContent = 'üòê';
      } else if (robotStatus.energy < 40) {
        moodIcon.textContent = 'üò™';
      } else {
        moodIcon.textContent = 'üôÇ';
      }
    }

    function createParticles(emoji, count = 5) {
      const container = document.getElementById('robot-container');
      
      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle side';
        particle.textContent = emoji;
        particle.style.left = '50%';
        particle.style.top = '50%';
        particle.style.setProperty('--x', (Math.random() - 0.5) * 150 + 'px');
        container.appendChild(particle);
        
        setTimeout(() => particle.remove(), 2000);
      }
    }

    function updateRobotStatus() {
      const now = Date.now();
      const timePassed = (now - robotStatus.lastVisit) / 1000 / 60;
      
      if (timePassed > 5) {
        robotStatus.energy = Math.max(10, robotStatus.energy - Math.floor(timePassed / 5));
        robotStatus.hunger = Math.max(10, robotStatus.hunger - Math.floor(timePassed / 3));
        robotStatus.mood = Math.max(20, robotStatus.mood - Math.floor(timePassed / 10));
      }
      
      robotStatus.lastVisit = now;
      updateStatusBars();
      updateRobotEmotion();
      saveRobotStatus();
    }

    function updateStatusBars() {
      const moodBar = document.getElementById('mood-bar');
      const energyBar = document.getElementById('energy-bar');
      const hungerBar = document.getElementById('hunger-bar');
      
      moodBar.style.width = robotStatus.mood + '%';
      energyBar.style.width = robotStatus.energy + '%';
      hungerBar.style.width = robotStatus.hunger + '%';
      
      document.getElementById('mood-value').textContent = robotStatus.mood + '%';
      document.getElementById('energy-value').textContent = robotStatus.energy + '%';
      document.getElementById('hunger-value').textContent = robotStatus.hunger + '%';
      document.getElementById('robot-level').textContent = robotStatus.level;
      
      moodBar.classList.toggle('low', robotStatus.mood < 30);
      energyBar.classList.toggle('low', robotStatus.energy < 30);
      hungerBar.classList.toggle('low', robotStatus.hunger < 30);
    }

    const updateStatusBarsThrottled = throttle(updateStatusBars, 100);

    function saveRobotStatus() {
      localStorage.setItem('robotMood', robotStatus.mood);
      localStorage.setItem('robotEnergy', robotStatus.energy);
      localStorage.setItem('robotHunger', robotStatus.hunger);
      localStorage.setItem('robotLevel', robotStatus.level);
      localStorage.setItem('robotLastVisit', robotStatus.lastVisit);
    }

    function updateUI() {
      document.getElementById('coins').textContent = coins;
      renderRoom();
    }

    function renderRoom() {
      const wallDecor = document.getElementById('wall-decor');
      const floorItems = document.getElementById('floor-items');
      wallDecor.innerHTML = '';
      floorItems.innerHTML = '';

      equippedDecor.wall.forEach(id => {
        const item = [...decorItems.wall, ...decorItems.floor].find(i => i.id === id);
        if (item) {
          const div = document.createElement('div');
          div.className = 'decor-item';
          div.textContent = item.icon;
          wallDecor.appendChild(div);
        }
      });

      equippedDecor.floor.forEach(id => {
        const item = [...decorItems.wall, ...decorItems.floor].find(i => i.id === id);
        if (item) {
          const div = document.createElement('div');
          div.className = 'furniture-item';
          div.textContent = item.icon;
          floorItems.appendChild(div);
        }
      });
    }

    const renderRoomOptimized = rafThrottle(renderRoom);

    function openDecorShop() {
      document.getElementById('modal').classList.add('active');
      renderShop();
    }

    function closeDecorShop() {
      document.getElementById('modal').classList.remove('active');
    }

    function closeModalOnOverlay(e) {
      if (e.target.id === 'modal') closeDecorShop();
    }

    function renderShop() {
      const grid = document.getElementById('decor-grid');
      grid.innerHTML = '';

      decorItems[currentCategory].forEach(item => {
        const owned = ownedDecor.includes(item.id);
        const equipped = equippedDecor[currentCategory].includes(item.id);

        const card = document.createElement('div');
        card.className = 'decor-card' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');
        card.onclick = () => handleDecorClick(item, owned, equipped);

        let status = '';
        if (equipped) status = '‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        else if (owned) status = 'üì¶ –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
        else status = `${item.price} üí∞`;

        card.innerHTML = `
          <div class="decor-icon">${item.icon}</div>
          <div class="decor-name">${item.name}</div>
          <div class="decor-status">${status}</div>
        `;

        grid.appendChild(card);
      });
    }

    function handleDecorClick(item, owned, equipped) {
      if (equipped) {
        equippedDecor[currentCategory] = equippedDecor[currentCategory].filter(id => id !== item.id);
        showBubble('–£–±—Ä–∞–ª!');
      } else if (owned) {
        if (equippedDecor[currentCategory].length >= 3) {
          showBubble('–ú–∞–∫—Å–∏–º—É–º 3!');
          return;
        }
        equippedDecor[currentCategory].push(item.id);
        showBubble('–£—Å—Ç–∞–Ω–æ–≤–∏–ª! üéâ');
        queueStatusUpdate('mood', Math.min(100, robotStatus.mood + 5));
        createParticles('‚ú®', 3);
      } else {
        if (coins < item.price) {
          showBubble('–ù–µ—Ç –º–æ–Ω–µ—Ç! üí∞');
          return;
        }
        coins -= item.price;
        ownedDecor.push(item.id);
        equippedDecor[currentCategory].push(item.id);
        showBubble('–ö—É–ø–ª–µ–Ω–æ! ‚ú®');
        playSound('buy');
        queueStatusUpdate('mood', Math.min(100, robotStatus.mood + 10));
        createParticles('üéâ', 5);
      }

      saveData();
      updateUI();
      renderShop();
    }

    function showCategory(category) {
      currentCategory = category;
      document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      renderShop();
    }

    function feedRobot() {
      if (coins < 10) {
        showBubble('–ù—É–∂–Ω–æ 10 –º–æ–Ω–µ—Ç! üí∞');
        return;
      }
      
      coins -= 10;
      queueStatusUpdate('hunger', Math.min(100, robotStatus.hunger + 30));
      queueStatusUpdate('energy', Math.min(100, robotStatus.energy + 20));
      queueStatusUpdate('mood', Math.min(100, robotStatus.mood + 15));
      
      showBubble('–ù—è–º-–Ω—è–º! üòãüçî');
      createParticles('üçî', 4);
      createParticles('‚ù§Ô∏è', 3);
      
      if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 80, spread: 70, origin: { x: 0.5, y: 0.6 } });
      }
      
      updateRobotEmotion();
      saveData();
      updateUI();
    }

    function showBubble(text) {
      const bubble = document.getElementById('bubble');
      bubble.textContent = text;
      bubble.classList.add('show');
      setTimeout(() => bubble.classList.remove('show'), 2500);
    }

    function playSound(type) {
      const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
      if (!soundEnabled) return;
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      if (type === 'buy') {
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
      }
      const volume = (parseInt(localStorage.getItem('soundVolume')) || 70) / 100 * 0.3;
      gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.2);
    }

    function saveData() {
      localStorage.setItem('neuroCoins', coins);
      localStorage.setItem('ownedDecor', JSON.stringify(ownedDecor));
      localStorage.setItem('equippedDecor', JSON.stringify(equippedDecor));
    }

    const saveDataDebounced = debounce(saveData, 500);

    document.getElementById('robot-model').addEventListener('click', function() {
      const phrases = [
        '–ü—Ä–∏–≤–µ—Ç! üëã',
        '–Ø —Ç—É—Ç! ü§ñ',
        '–ß—Ç–æ –¥–µ–ª–∞–µ–º? üéÆ',
        '–£–∫—Ä–∞—Å—å –∫–æ–º–Ω–∞—Ç—É! üé®',
        '–°–º–æ—Ç—Ä–∏ –≤ –æ–∫–Ω–æ! ü§©',
        '–ü–æ–∫–æ—Ä–º–∏ –º–µ–Ω—è! üçî',
        '–î–∞–≤–∞–π –∏–≥—Ä–∞—Ç—å! üéØ'
      ];
      showBubble(phrases[Math.floor(Math.random() * phrases.length)]);
      queueStatusUpdate('mood', Math.min(100, robotStatus.mood + 2));
      createParticles('‚ù§Ô∏è', 3);
      updateRobotEmotion();
    });

    updateUI();
    updateRobotStatus();
    
    setTimeout(() => {
      if (robotStatus.mood < 40) {
        showBubble('–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ... üòû');
      } else if (robotStatus.energy < 30) {
        showBubble('–Ø —É—Å—Ç–∞–ª... üò¥');
        createParticles('üí§', 3);
      } else if (robotStatus.hunger < 30) {
        showBubble('–•–æ—á—É –∫—É—à–∞—Ç—å! üçî');
      } else {
        showBubble('–ü—Ä–∏–≤–µ—Ç! üëã');
      }
    }, 1000);

    function updateLoop() {
      flushUpdates();
      requestAnimationFrame(updateLoop);
    }
    updateLoop();

    function startStatusDegradation() {
      if (window.statusInterval) {
        clearInterval(window.statusInterval);
      }
      
      window.statusInterval = setInterval(() => {
        if (!isPageVisible) return;
        
        robotStatus.energy = Math.max(10, robotStatus.energy - 1);
        robotStatus.hunger = Math.max(10, robotStatus.hunger - 1);
        if (robotStatus.energy < 30 || robotStatus.hunger < 30) {
          robotStatus.mood = Math.max(10, robotStatus.mood - 1);
        }
        updateStatusBarsThrottled();
        updateRobotEmotion();
        saveRobotStatus();
      }, 60000);
    }
    
    startStatusDegradation();
  </script>
</body>
</html>