<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –î–æ–∂–¥—å</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .game-area {
            position: relative;
            width: 95%;
            height: 60vh;
            border-bottom: 3px solid var(--primary);
            overflow: hidden;
            background: linear-gradient(to bottom, #eef2f5, #e3f2fd);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .falling-item {
            position: absolute;
            top: -50px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--text);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        
        .falling-item.error { background: var(--error); color: white; }

        .controls-math {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 350px;
        }

        .btn-math {
            background: white;
            border: none;
            padding: 15px;
            font-size: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 0 #dce0e6;
            cursor: pointer;
        }
        .btn-math:active { transform: translateY(4px); box-shadow: none; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω–µ–≥ */
        .coin-popup {
            position: absolute;
            color: #FFC107;
            font-weight: bold;
            font-size: 1.5rem;
            animation: floatUp 1s forwards;
            pointer-events: none;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div class="top-bar">
        <a href="../index.html" class="btn-back">‚Üê</a>
        <div>
            <div class="game-info" id="score">0</div>
            <div style="font-size: 0.9rem; color: #FFC107; text-align: right; font-weight: bold;">+ <span id="earned-coins">0</span> üí∞</div>
        </div>
    </div>

    <div class="screen" style="justify-content: flex-start; padding-top: 20px;">
        
        <div class="game-area" id="game-area">
            <!-- –°—é–¥–∞ –ø–∞–¥–∞—é—Ç –ø—Ä–∏–º–µ—Ä—ã -->
        </div>

        <div class="controls-math">
            <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è) -->
            <button class="btn-math" onclick="checkAnswer(1)">1</button>
            <button class="btn-math" onclick="checkAnswer(2)">2</button>
            <button class="btn-math" onclick="checkAnswer(3)">3</button>
        </div>
        
        <div style="margin-top:10px; color:#777;">–ñ–∏–∑–Ω–∏: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <script>
        // --- –ó–í–£–ö–ò ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'pop') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if(type === 'crash') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- –õ–û–ì–ò–ö–ê ---
        let score = 0;
        let lives = 3;
        let gameLoop;
        let spawnInterval;
        let items = []; // –ú–∞—Å—Å–∏–≤ –ø–∞–¥–∞—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        let speed = 1.5; // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
        let isPlaying = false;
        
        const area = document.getElementById('game-area');
        
        function initGame() {
            score = 0;
            lives = 3;
            speed = 1.5;
            items = [];
            area.innerHTML = '';
            isPlaying = true;
            document.getElementById('score').innerText = score;
            document.getElementById('lives').innerText = '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
            document.getElementById('earned-coins').innerText = 0;

            generateButtons(); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–∫–∞ —Å—Ç–∞—Ç–∏–∫ 1-9, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
            
            // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–≥—Ä—ã (–¥–≤–∏–∂–µ–Ω–∏–µ)
            gameLoop = setInterval(updateGame, 20);
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤
            spawnInterval = setInterval(spawnItem, 2000);
        }

        function generateButtons() {
            const container = document.querySelector('.controls-math');
            container.innerHTML = '';
            for(let i=1; i<=9; i++) {
                container.innerHTML += `<button class="btn-math" onclick="checkAnswer(${i})">${i}</button>`;
            }
        }

        function spawnItem() {
            if(!isPlaying) return;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç 1 –¥–æ 9)
            let result = Math.floor(Math.random() * 9) + 1;
            let a = Math.floor(Math.random() * result);
            let b = result - a;
            
            // –ò–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º –≤—ã—á–∏—Ç–∞–Ω–∏–µ
            if(Math.random() > 0.5 && result < 9) {
                let tempRes = result;
                a = Math.floor(Math.random() * 5) + result; // a –±–æ–ª—å—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                b = a - result; // a - b = result
                // –¢–µ–∫—Å—Ç –±—É–¥–µ—Ç "a - b"
            }

            let text = `${a} + ${b}`;
            // –ï—Å–ª–∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
            if(Math.random() > 0.5) { // 50% —à–∞–Ω—Å –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ª–æ–∂–µ–Ω–∏—è
                 // –û—Å—Ç–∞–≤–∏–º –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ —Å–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ—Ç–µ–π 8 –ª–µ—Ç, —á—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å –∫–æ–¥
            }

            let item = document.createElement('div');
            item.className = 'falling-item';
            item.innerText = text;
            item.style.left = Math.random() * (area.clientWidth - 60) + 'px';
            item.dataset.val = result; // –•—Ä–∞–Ω–∏–º –æ—Ç–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏
            
            // –ü–æ–∑–∏—Ü–∏—è Y
            item.dataset.y = -50;
            
            area.appendChild(item);
            items.push(item);
            
            // –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ
            if(score > 5) speed = 2;
            if(score > 15) speed = 3;
        }

        function updateGame() {
            if(!isPlaying) return;

            items.forEach((item, index) => {
                let y = parseFloat(item.dataset.y);
                y += speed;
                item.dataset.y = y;
                item.style.top = y + 'px';

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞–¥–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª
                if(y > area.clientHeight - 40) {
                    loseLife();
                    item.remove();
                    items.splice(index, 1);
                }
            });
        }

                function checkAnswer(val) {
            if(!isPlaying) return;
            
            // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å —ç–ª–µ–º–µ–Ω—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–æ–π
            // findIndex –Ω–∞–π–¥–µ—Ç –ü–ï–†–í–´–ô –ø–æ–¥—Ö–æ–¥—è—â–∏–π —ç–ª–µ–º–µ–Ω—Ç (—Ç–æ—Ç, —á—Ç–æ –±—ã–ª —Å–æ–∑–¥–∞–Ω —Ä–∞–Ω—å—à–µ = –Ω–∏–∂–µ –≤—Å–µ—Ö)
            let foundIndex = items.findIndex(item => parseInt(item.dataset.val) === val);

            if(foundIndex !== -1) {
                // –ü–†–ê–í–ò–õ–¨–ù–û!
                playSound('pop');
                let item = items[foundIndex];
                
                // –ê–Ω–∏–º–∞—Ü–∏—è +1 –º–æ–Ω–µ—Ç—ã –≤ –º–µ—Å—Ç–µ, –≥–¥–µ –±—ã–ª –ø—Ä–∏–º–µ—Ä
                showCoinAnim(item.style.left, item.style.top);
                
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ —Å—Ü–µ–Ω—ã –∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞
                item.remove();
                items.splice(foundIndex, 1);
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
                score++;
                document.getElementById('score').innerText = score;
                document.getElementById('earned-coins').innerText = score;
            } else {
                // –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–∏–ª–∏ –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫ –æ—à–∏–±–∫–∏ –∏–ª–∏ –≤–∏–±—Ä–∞—Ü–∏—é
                if (navigator.vibrate) navigator.vibrate(50);
                
                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ—à–∏–±–∫–∏ (—Ç—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞)
                const gameArea = document.getElementById('game-area');
                gameArea.style.borderBottom = "3px solid red";
                setTimeout(() => gameArea.style.borderBottom = "3px solid var(--primary)", 200);
            }
        }

            if(foundIndex !== -1) {
                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
                playSound('pop');
                let item = items[foundIndex];
                
                // –≠—Ñ—Ñ–µ–∫—Ç –º–æ–Ω–µ—Ç–∫–∏
                showCoinAnim(item.style.left, item.style.top);
                
                item.remove();
                items.splice(foundIndex, 1);
                score++;
                document.getElementById('score').innerText = score;
                document.getElementById('earned-coins').innerText = score; // 1 –æ—á–∫–æ = 1 –º–æ–Ω–µ—Ç–∞
            } else {
                // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–º–æ–∂–Ω–æ —à—Ç—Ä–∞—Ñ–æ–≤–∞—Ç—å, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∑–≤—É–∫)
                // navigator.vibrate(50);
            }
        }

        function loseLife() {
            playSound('crash');
            lives--;
            let hearts = '';
            for(let i=0; i<lives; i++) hearts += '‚ù§Ô∏è';
            document.getElementById('lives').innerText = hearts;
            
            area.style.background = '#ffebee';
            setTimeout(()=> area.style.background = '', 200);

            if(lives <= 0) gameOver();
        }

        function showCoinAnim(x, y) {
            let el = document.createElement('div');
            el.className = 'coin-popup';
            el.innerText = '+1 üí∞';
            el.style.left = x;
            el.style.top = y;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function gameOver() {
            isPlaying = false;
            clearInterval(gameLoop);
            clearInterval(spawnInterval);
            
            // –°–û–•–†–ê–ù–ï–ù–ò–ï –ú–û–ù–ï–¢ –í –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ë–ê–ù–ö
            saveCoinsToBank(score);
            
            confetti();
            alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –º–æ–Ω–µ—Ç: ${score}`);
            window.location.href = '../index.html';
        }

        function saveCoinsToBank(amount) {
            let currentBank = parseInt(localStorage.getItem('neuroCoins')) || 0;
            let newBalance = currentBank + amount;
            localStorage.setItem('neuroCoins', newBalance);
        }

        // –°—Ç–∞—Ä—Ç
        document.body.addEventListener('click', () => { if (audioCtx.state === 'suspended') audioCtx.resume(); }, { once: true });
        initGame();

    </script>
</body>
</html>

