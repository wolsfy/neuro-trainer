<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –î–æ–∂–¥—å</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è Math Rain --- */
        
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.15);
            padding: 15px;
            border-radius: 0 0 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .score-container {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .score-box {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 1.4rem;
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
            min-width: 60px;
            text-align: center;
        }
        
        .coins-box {
            background: linear-gradient(135deg, #FFC107, #FF9800);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 1.2rem;
            box-shadow: 0 3px 8px rgba(255, 193, 7, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .game-area {
            position: relative;
            width: 95%;
            height: 58vh;
            border-bottom: 3px solid var(--primary);
            overflow: hidden;
            background: linear-gradient(to bottom, #eef2f5, #e3f2fd);
            border-radius: 12px;
            margin-bottom: 15px;
            touch-action: none;
        }

        .falling-item {
            position: absolute;
            top: -60px;
            background: white;
            padding: 10px 18px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 1.6rem;
            color: var(--text);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border: 2px solid #fff;
            z-index: 10;
        }
        
        .controls-math {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 95%;
            max-width: 400px;
            margin-bottom: 12px;
        }

        .btn-math {
            background: white;
            border: none;
            padding: 20px 0;
            font-size: 1.8rem;
            border-radius: 16px;
            box-shadow: 0 4px 0 #dce0e6;
            cursor: pointer;
            color: var(--primary);
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-math:active { 
            transform: translateY(4px); 
            box-shadow: none; 
            background: #f5f5f5;
        }

        .coin-popup {
            position: absolute;
            color: #FFC107;
            font-weight: 900;
            font-size: 1.8rem;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 20;
        }
        @keyframes floatUp { 
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.2); opacity: 0; } 
        }
        
        .lives-display {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text);
            padding-bottom: 20px;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div class="top-bar">
        <a href="../index.html" class="btn-back">‚Üê</a>
        <div class="score-container">
            <div class="score-box" id="score">0</div>
            <div class="coins-box">
                <span id="earned-coins">0</span>
                <span>üí∞</span>
            </div>
        </div>
    </div>

    <div class="screen" style="justify-content: flex-start; padding-top: 85px; padding-bottom: 10px;">
        
        <div class="game-area" id="game-area">
            <!-- –°—é–¥–∞ –ø–∞–¥–∞—é—Ç –ø—Ä–∏–º–µ—Ä—ã -->
        </div>

        <div class="controls-math">
            <!-- –ö–Ω–æ–ø–∫–∏ 1-9 -->
            <button class="btn-math" onclick="checkAnswer(1)">1</button>
            <button class="btn-math" onclick="checkAnswer(2)">2</button>
            <button class="btn-math" onclick="checkAnswer(3)">3</button>
            <button class="btn-math" onclick="checkAnswer(4)">4</button>
            <button class="btn-math" onclick="checkAnswer(5)">5</button>
            <button class="btn-math" onclick="checkAnswer(6)">6</button>
            <button class="btn-math" onclick="checkAnswer(7)">7</button>
            <button class="btn-math" onclick="checkAnswer(8)">8</button>
            <button class="btn-math" onclick="checkAnswer(9)">9</button>
        </div>
        
        <div class="lives-display">–ñ–∏–∑–Ω–∏: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <script>
        // --- –ó–í–£–ö–ò (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'pop') {
                // –ü—Ä–∏—è—Ç–Ω—ã–π "–ø—É–ø"
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if(type === 'crash') {
                // –ó–≤—É–∫ —É–¥–∞—Ä–∞ –æ–± –ø–æ–ª
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
        let score = 0;
        let lives = 3;
        let animationFrameId;
        let spawnIntervalId;
        
        let items = []; 
        let isPlaying = false;
        
        const area = document.getElementById('game-area');

        function initGame() {
            score = 0;
            lives = 3;
            items = [];
            area.innerHTML = '';
            isPlaying = true;
            
            document.getElementById('score').innerText = score;
            document.getElementById('lives').innerText = '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
            document.getElementById('earned-coins').innerText = 0;
            
            animationFrameId = requestAnimationFrame(gameLoop);
            spawnIntervalId = setInterval(spawnItem, 2000);
        }

        function spawnItem() {
            if(!isPlaying) return;
            
            let result = Math.floor(Math.random() * 9) + 1;
            let a = Math.floor(Math.random() * result);
            let b = result - a;
            let text = `${a} + ${b}`;

            let el = document.createElement('div');
            el.className = 'falling-item';
            el.innerText = text;
            el.style.left = Math.random() * (area.clientWidth - 90) + 'px'; 
            area.appendChild(el);

            let currentSpeed = 1.5 + (Math.floor(score / 10) * 0.4); 

            items.push({
                el: el,
                y: -60,
                val: result,
                speed: currentSpeed
            });
        }

        function gameLoop() {
            if (!isPlaying) return;
            animationFrameId = requestAnimationFrame(gameLoop);

            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += item.speed;
                item.el.style.top = item.y + 'px';

                if (item.y > area.clientHeight - 50) {
                    loseLife();
                    item.el.remove();
                    items.splice(i, 1);
                }
            }
        }

        function checkAnswer(val) {
            if(!isPlaying) return;
            
            let candidates = [];
            items.forEach((item, index) => {
                if (item.val === val) {
                    candidates.push({ index: index, y: item.y });
                }
            });

            if (candidates.length > 0) {
                candidates.sort((a, b) => b.y - a.y);
                let target = candidates[0];
                let itemToRemove = items[target.index];

                playSound('pop');
                showCoinAnim(itemToRemove.el.style.left, itemToRemove.el.style.top);
                
                itemToRemove.el.remove();
                items.splice(target.index, 1); 
                
                score++;
                document.getElementById('score').innerText = score;
                document.getElementById('earned-coins').innerText = score;
            } else {
                if (navigator.vibrate) navigator.vibrate(50);
                const ga = document.getElementById('game-area');
                ga.style.borderBottom = "3px solid #FF5252";
                setTimeout(() => ga.style.borderBottom = "3px solid var(--primary)", 200);
            }
        }

        function loseLife() {
            playSound('crash');
            lives--;
            
            let hearts = '';
            for(let i=0; i<lives; i++) hearts += '‚ù§Ô∏è';
            document.getElementById('lives').innerText = hearts;
            
            area.style.background = '#ffebee';
            setTimeout(()=> area.style.background = '', 200);

            if(lives <= 0) gameOver();
        }

        function showCoinAnim(x, y) {
            let el = document.createElement('div');
            el.className = 'coin-popup';
            el.innerText = '+1 üí∞';
            el.style.left = x;
            el.style.top = y;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function gameOver() {
            isPlaying = false;
            cancelAnimationFrame(animationFrameId);
            clearInterval(spawnIntervalId);
            
            saveCoinsToBank(score);
            
            confetti();
            alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏: ${score} –º–æ–Ω–µ—Ç`);
            window.location.href = '../index.html';
        }

        function saveCoinsToBank(amount) {
            let currentBank = parseInt(localStorage.getItem('neuroCoins')) || 0;
            let newBalance = currentBank + amount;
            localStorage.setItem('neuroCoins', newBalance);
        }

        document.body.addEventListener('click', () => { 
            if (audioCtx.state === 'suspended') audioCtx.resume(); 
        }, { once: true });
        
        setTimeout(initGame, 100);

    </script>
</body>
</html>
