<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –î–æ–∂–¥—å</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è Math Rain --- */
        
        /* –£–ª—É—á—à–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
        .top-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 15px;
            border-radius: 0 0 16px 16px;
        }
        
        .score-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .score-display .game-info {
            font-size: 1.6rem;
            color: var(--primary);
            font-weight: 900;
        }
        
        .coins-display {
            font-size: 1rem;
            color: #FFC107;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .game-area {
            position: relative;
            width: 95%;
            height: 60vh; /* –í—ã—Å–æ—Ç–∞ –ø–æ–ª—è - 60% –æ—Ç —ç–∫—Ä–∞–Ω–∞ */
            border-bottom: 3px solid var(--primary);
            overflow: hidden;
            background: linear-gradient(to bottom, #eef2f5, #e3f2fd);
            border-radius: 12px;
            margin-bottom: 20px;
            touch-action: none; /* –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫—Ä–æ–ª–ª–∞ */
        }

        .falling-item {
            position: absolute;
            top: -60px; /* –ù–∞—á–∏–Ω–∞–µ—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞ */
            background: white;
            padding: 10px 18px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 1.6rem;
            color: var(--text);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border: 2px solid #fff;
            z-index: 10;
        }
        
        .controls-math {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 95%;
            max-width: 400px;
        }

        .btn-math {
            background: white;
            border: none;
            padding: 20px 0;
            font-size: 1.8rem;
            border-radius: 16px;
            box-shadow: 0 4px 0 #dce0e6;
            cursor: pointer;
            color: var(--primary);
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-math:active { 
            transform: translateY(4px); 
            box-shadow: none; 
            background: #f5f5f5;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω–µ–≥ */
        .coin-popup {
            position: absolute;
            color: #FFC107;
            font-weight: 900;
            font-size: 1.8rem;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 20;
        }
        @keyframes floatUp { 
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.2); opacity: 0; } 
        }
        
        .lives-display {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text);
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div class="top-bar">
        <a href="../index.html" class="btn-back">‚Üê</a>
        <div class="score-display">
            <div class="game-info" id="score">0</div>
            <div class="coins-display">
                <span>+</span>
                <span id="earned-coins">0</span>
                <span>üí∞</span>
            </div>
        </div>
    </div>

    <div class="screen" style="justify-content: flex-start; padding-top: 80px;">
        
        <div class="game-area" id="game-area">
            <!-- –°—é–¥–∞ –ø–∞–¥–∞—é—Ç –ø—Ä–∏–º–µ—Ä—ã -->
        </div>

        <div class="controls-math">
            <!-- –ö–Ω–æ–ø–∫–∏ 1-9 -->
            <button class="btn-math" onclick="checkAnswer(1)">1</button>
            <button class="btn-math" onclick="checkAnswer(2)">2</button>
            <button class="btn-math" onclick="checkAnswer(3)">3</button>
            <button class="btn-math" onclick="checkAnswer(4)">4</button>
            <button class="btn-math" onclick="checkAnswer(5)">5</button>
            <button class="btn-math" onclick="checkAnswer(6)">6</button>
            <button class="btn-math" onclick="checkAnswer(7)">7</button>
            <button class="btn-math" onclick="checkAnswer(8)">8</button>
            <button class="btn-math" onclick="checkAnswer(9)">9</button>
        </div>
        
        <div class="lives-display">–ñ–∏–∑–Ω–∏: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <script>
        // --- –ó–í–£–ö–ò (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'pop') {
                // –ü—Ä–∏—è—Ç–Ω—ã–π "–ø—É–ø"
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if(type === 'crash') {
                // –ó–≤—É–∫ —É–¥–∞—Ä–∞ –æ–± –ø–æ–ª
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
        let score = 0;
        let lives = 3;
        let animationFrameId; // ID –∞–Ω–∏–º–∞—Ü–∏–∏
        let spawnIntervalId;
        
        // –ì–ª–∞–≤–Ω—ã–π –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { el: DOMNode, y: number, val: number, speed: number }
        let items = []; 
        let isPlaying = false;
        
        const area = document.getElementById('game-area');

        function initGame() {
            score = 0;
            lives = 3;
            items = [];
            area.innerHTML = '';
            isPlaying = true;
            
            document.getElementById('score').innerText = score;
            document.getElementById('lives').innerText = '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
            document.getElementById('earned-coins').innerText = 0;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª (–¥–≤–∏–∂–µ–Ω–∏–µ)
            animationFrameId = requestAnimationFrame(gameLoop);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫)
            spawnIntervalId = setInterval(spawnItem, 2000);
        }

        function spawnItem() {
            if(!isPlaying) return;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–∞ (–æ—Ç–≤–µ—Ç 1-9)
            let result = Math.floor(Math.random() * 9) + 1;
            let a = Math.floor(Math.random() * result);
            let b = result - a;
            let text = `${a} + ${b}`;

            // –°–æ–∑–¥–∞–µ–º HTML —ç–ª–µ–º–µ–Ω—Ç
            let el = document.createElement('div');
            el.className = 'falling-item';
            el.innerText = text;
            
            // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ X (—Å –æ—Ç—Å—Ç—É–ø–æ–º –æ—Ç –∫—Ä–∞–µ–≤)
            // area.clientWidth - 80, —á—Ç–æ–±—ã –±–ª–æ–∫ –Ω–µ –≤—ã–ª–µ–∑ –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
            el.style.left = Math.random() * (area.clientWidth - 90) + 'px'; 
            area.appendChild(el);

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å (—É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –æ—Ç –æ—á–∫–æ–≤)
            // –ë–∞–∑–æ–≤–∞—è 1.5 + 0.5 –∑–∞ –∫–∞–∂–¥—ã–µ 10 –æ—á–∫–æ–≤
            let currentSpeed = 1.5 + (Math.floor(score / 10) * 0.4); 

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
            items.push({
                el: el,
                y: -60,       // –ù–∞—á–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ (–∑–∞ –∫—Ä–∞–µ–º)
                val: result,  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                speed: currentSpeed
            });
        }

        // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –∞–Ω–∏–º–∞—Ü–∏–∏ (60 FPS)
        function gameLoop() {
            if (!isPlaying) return;

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
            animationFrameId = requestAnimationFrame(gameLoop);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            // –ò–¥–µ–º —Å –∫–æ–Ω—Ü–∞ –º–∞—Å—Å–∏–≤–∞, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª—è—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                
                // –î–≤–∏–≥–∞–µ–º –≤–Ω–∏–∑
                item.y += item.speed;
                item.el.style.top = item.y + 'px';

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞–¥–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª
                // –í—ã—Å–æ—Ç–∞ –ø–æ–ª—è –º–∏–Ω—É—Å –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ (~50px)
                if (item.y > area.clientHeight - 50) {
                    loseLife();
                    
                    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                    item.el.remove();
                    items.splice(i, 1);
                }
            }
        }

        function checkAnswer(val) {
            if(!isPlaying) return;
            
            // 1. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–∞–¥–∞—é—â–∏–µ –ø—Ä–∏–º–µ—Ä—ã —Å —Ç–∞–∫–∏–º –æ—Ç–≤–µ—Ç–æ–º
            let candidates = [];
            items.forEach((item, index) => {
                if (item.val === val) {
                    candidates.push({ index: index, y: item.y });
                }
            });

            if (candidates.length > 0) {
                // 2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Ö –ø–æ –≤—ã—Å–æ—Ç–µ (Y). –ù–∞–º –Ω—É–∂–µ–Ω —Ç–æ—Ç, —É –∫–æ–≥–æ Y –±–æ–ª—å—à–µ (–æ–Ω –Ω–∏–∂–µ)
                candidates.sort((a, b) => b.y - a.y);
                
                // –ë–µ—Ä–µ–º —Å–∞–º—ã–π –Ω–∏–∂–Ω–∏–π (–ø–µ—Ä–≤—ã–π –≤ —Å–ø–∏—Å–∫–µ)
                let target = candidates[0];
                let itemToRemove = items[target.index];

                // 3. –≠—Ñ—Ñ–µ–∫—Ç—ã —É—Å–ø–µ—Ö–∞
                playSound('pop');
                showCoinAnim(itemToRemove.el.style.left, itemToRemove.el.style.top);
                
                // 4. –£–¥–∞–ª—è–µ–º
                itemToRemove.el.remove();
                
                // –í–∞–∂–Ω–æ: —É–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ items –ø–æ –∏–Ω–¥–µ–∫—Å—É
                items.splice(target.index, 1); 
                
                // 5. –û—á–∫–∏
                score++;
                document.getElementById('score').innerText = score;
                document.getElementById('earned-coins').innerText = score;
            } else {
                // –û—à–∏–±–∫–∞ (–Ω–µ—Ç —Ç–∞–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
                if (navigator.vibrate) navigator.vibrate(50);
                
                // –ö—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                const ga = document.getElementById('game-area');
                ga.style.borderBottom = "3px solid #FF5252";
                setTimeout(() => ga.style.borderBottom = "3px solid var(--primary)", 200);
            }
        }

        function loseLife() {
            playSound('crash');
            lives--;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–¥—Ü–∞
            let hearts = '';
            for(let i=0; i<lives; i++) hearts += '‚ù§Ô∏è';
            document.getElementById('lives').innerText = hearts;
            
            // –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –ø—Ä–∏ —É—Ä–æ–Ω–µ
            area.style.background = '#ffebee';
            setTimeout(()=> area.style.background = '', 200);

            if(lives <= 0) gameOver();
        }

        function showCoinAnim(x, y) {
            let el = document.createElement('div');
            el.className = 'coin-popup';
            el.innerText = '+1 üí∞';
            el.style.left = x;
            el.style.top = y;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function gameOver() {
            isPlaying = false;
            cancelAnimationFrame(animationFrameId);
            clearInterval(spawnIntervalId);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–Ω–µ—Ç—ã
            saveCoinsToBank(score);
            
            confetti();
            alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏: ${score} –º–æ–Ω–µ—Ç`);
            window.location.href = '../index.html';
        }

        function saveCoinsToBank(amount) {
            let currentBank = parseInt(localStorage.getItem('neuroCoins')) || 0;
            let newBalance = currentBank + amount;
            localStorage.setItem('neuroCoins', newBalance);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–æ–≤)
        document.body.addEventListener('click', () => { 
            if (audioCtx.state === 'suspended') audioCtx.resume(); 
        }, { once: true });
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (—á—Ç–æ–±—ã —Å—Ç–∏–ª–∏ –ø—Ä–æ–≥—Ä—É–∑–∏–ª–∏—Å—å)
        setTimeout(initGame, 100);

    </script>
</body>
</html>
