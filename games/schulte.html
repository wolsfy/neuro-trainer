<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–±–ª–∏—Ü–∞ –®—É–ª—å—Ç–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â–∏–π —Å—Ç–∏–ª—å –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–ø–∫–∏ -->
    <link rel="stylesheet" href="../css/style.css">
    
    <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã -->
    <style>
        /* –°–µ—Ç–∫–∞ –∏–≥—Ä—ã */
        .schulte-grid {
            display: grid;
            gap: 10px;
            width: 92vw;
            max-width: 400px;
            aspect-ratio: 1; /* –î–µ–ª–∞–µ—Ç —Å–µ—Ç–∫—É –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π */
            margin-top: 20px;
        }

        /* –†–µ–∂–∏–º—ã —Å–µ—Ç–∫–∏ */
        .schulte-grid.size-3 { grid-template-columns: repeat(3, 1fr); }
        .schulte-grid.size-5 { grid-template-columns: repeat(5, 1fr); }
        
        /* –Ø—á–µ–π–∫–∞ —Å —á–∏—Å–ª–æ–º */
        .cell {
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 0 #dce0e6; /* –û–±—ä–µ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
        }

        .cell:active {
            transform: translateY(4px); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
            box-shadow: none;
        }

        /* –¶–µ–ª—å (–∫–æ–≥–æ –∏—â–µ–º) */
        .target-display {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
        .target-number {
            font-size: 2.5rem;
            color: var(--primary);
            font-weight: bold;
            margin-left: 10px;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤–Ω–∏–∑—É) */
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-mode {
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            background: #E0E0E0;
            color: #555;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-mode.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
        }

        .btn-restart {
            background: #FF9800; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
            color: white;
        }
        
        .best-score {
            font-size: 0.9rem;
            color: #FF9800;
            font-weight: bold;
            text-align: right;
        }
    </style>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–∞–ª—é—Ç–∞ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –∏ –¢–∞–π–º–µ—Ä -->
    <div class="top-bar">
        <a href="../index.html" class="btn-back">‚Üê</a>
        <div>
            <div class="game-info" id="timer">00.00</div>
            <div class="best-score" id="best-score">üèÜ --:--</div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
    <div class="screen">
        <div class="target-display">
            –ò—â–∏ —á–∏—Å–ª–æ: <span id="target-num" class="target-number">1</span>
        </div>

        <div id="grid" class="schulte-grid size-5">
            <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>

        <div class="controls">
            <button class="btn-mode" id="mode-3" onclick="setMode(3)">3x3</button>
            <button class="btn-mode active" id="mode-5" onclick="setMode(5)">5x5</button>
            <button class="btn-mode btn-restart" onclick="restartGame()">‚Üª</button>
        </div>
    </div>

    <script>
        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let currentGridSize = 5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5x5
        let currentTarget = 1;   // –ö–∞–∫–æ–µ —á–∏—Å–ª–æ –∏—â–µ–º —Å–µ–π—á–∞—Å
        let timerInterval;       // ID —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        let isPlaying = false;   // –ò–¥–µ—Ç –ª–∏ –∏–≥—Ä–∞

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const gridElement = document.getElementById('grid');
        const targetElement = document.getElementById('target-num');
        const timerElement = document.getElementById('timer');
        const bestScoreElement = document.getElementById('best-score');

        // --- –ó–í–£–ö–ò (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'click') {
                // –ü—Ä–∏—è—Ç–Ω—ã–π "–∫–ª–∏–∫"
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            } 
            else if (type === 'error') {
                // –ù–∏–∑–∫–∏–π –∑–≤—É–∫ –æ—à–∏–±–∫–∏
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            } 
            else if (type === 'win') {
                // –ê–∫–∫–æ—Ä–¥ –ø–æ–±–µ–¥—ã
                [440, 554, 659].forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                    o.start(audioCtx.currentTime + i * 0.1);
                    o.stop(audioCtx.currentTime + 1.5 + i * 0.1);
                });
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---

        // –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ (3x3 –∏–ª–∏ 5x5)
        function setMode(size) {
            currentGridSize = size;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mode-${size}`).classList.add('active');
            
            // –ú–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Å–µ—Ç–∫–∏ –¥–ª—è CSS
            gridElement.className = `schulte-grid size-${size}`;
            
            updateBestScoreDisplay();
            restartGame();
        }

        function updateBestScoreDisplay() {
            const key = `schulte_best_${currentGridSize}`;
            const best = localStorage.getItem(key);
            if (best) {
                bestScoreElement.innerText = `üèÜ ${best}—Å`;
            } else {
                bestScoreElement.innerText = `üèÜ --:--`;
            }
        }

        function restartGame() {
            isPlaying = true;
            currentTarget = 1;
            targetElement.innerText = "1";
            timerElement.innerText = "00.00";
            
            // –°–±—Ä–æ—Å –∏ –∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
            clearInterval(timerInterval);
            let startTime = Date.now();
            timerInterval = setInterval(() => {
                let delta = (Date.now() - startTime) / 1000;
                timerElement.innerText = delta.toFixed(2);
            }, 50);

            renderGrid();
        }

        function renderGrid() {
            gridElement.innerHTML = '';
            const count = currentGridSize * currentGridSize; // 9 –∏–ª–∏ 25
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª [1, 2, 3...]
            let numbers = [];
            for (let i = 1; i <= count; i++) {
                numbers.push(i);
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ (–∞–ª–≥–æ—Ä–∏—Ç–º –§–∏—à–µ—Ä–∞-–ô–µ–π—Ç—Å–∞)
            numbers.sort(() => Math.random() - 0.5);

            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
            numbers.forEach(num => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = num;
                
                // –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–µ—Ç–∫–∏
                cell.style.fontSize = currentGridSize === 3 ? '3rem' : '2rem';

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è (pointerdown —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ click –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
                cell.onpointerdown = (e) => {
                    e.preventDefault(); // –ß—Ç–æ–±—ã –Ω–µ –≤—ã–¥–µ–ª—è–ª—Å—è —Ç–µ–∫—Å—Ç
                    handleCellClick(cell, num, count);
                };

                gridElement.appendChild(cell);
            });
        }

        function handleCellClick(cell, number, maxNumber) {
            if (!isPlaying) return;

            if (number === currentTarget) {
                // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª–∏–∫
                playSound('click');
                cell.classList.add('correct-anim'); // –ó–µ–ª–µ–Ω–∞—è –≤—Å–ø—ã—à–∫–∞
                
                currentTarget++;

                if (currentTarget > maxNumber) {
                    gameWin();
                } else {
                    targetElement.innerText = currentTarget;
                }
            } else {
                // –û—à–∏–±–∫–∞
                playSound('error');
                cell.style.backgroundColor = '#FF5252'; // –ö—Ä–∞—Å–Ω—ã–π
                cell.style.color = 'white';
                
                // –í–æ–∑–≤—Ä–∞—Ç —Ü–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ 300–º—Å
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                    cell.style.color = '';
                }, 300);
            }
        }

        function gameWin() {
            isPlaying = false;
            clearInterval(timerInterval);
            playSound('win');
            confetti(); // –°–∞–ª—é—Ç!

            // --- –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ú–û–ù–ï–¢ ---
            let reward = 15; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
            saveCoins(reward);
            // -----------------------

            const finalTime = parseFloat(timerElement.innerText);
            checkRecord(finalTime, reward);
        }

        function checkRecord(time, reward) {
            const key = `schulte_best_${currentGridSize}`;
            const oldRecord = parseFloat(localStorage.getItem(key)) || 9999;

            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∞–ª–µ—Ä—Ç–æ–º
            setTimeout(() => {
                let msg = `–ü–æ–±–µ–¥–∞! –í—Ä–µ–º—è: ${time} —Å\n–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${reward} –º–æ–Ω–µ—Ç! üí∞`;
                
                if (time < oldRecord) {
                    localStorage.setItem(key, time);
                    msg += `\nüéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!`;
                    updateBestScoreDisplay();
                }
                
                alert(msg);
                
                // –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é –∏–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
                // window.location.href = '../index.html'; 
            }, 500);
        }

        function saveCoins(amount) {
            let currentBank = parseInt(localStorage.getItem('neuroCoins')) || 0;
            localStorage.setItem('neuroCoins', currentBank + amount);
        }

        // --- –°–¢–ê–†–¢ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
        document.body.addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });

        document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });

        updateBestScoreDisplay();
        restartGame();

    </script>
</body>
</html>
