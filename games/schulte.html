<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–±–ª–∏—Ü–∞ –®—É–ª—å—Ç–µ</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/robot-animations.css">
    
    <style>
        .schulte-grid {
            display: grid;
            gap: 10px;
            width: 92vw;
            max-width: 400px;
            aspect-ratio: 1;
            margin-top: 20px;
        }
        .schulte-grid.size-3 { grid-template-columns: repeat(3, 1fr); }
        .schulte-grid.size-5 { grid-template-columns: repeat(5, 1fr); }
        
        .cell {
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 0 #dce0e6;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
        }
        .cell:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .target-display {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
        .target-number {
            font-size: 2.5rem;
            color: var(--primary);
            font-weight: bold;
            margin-left: 10px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        .btn-mode {
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            background: #E0E0E0;
            color: #555;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn-mode.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
        }
        .btn-restart {
            background: #FF9800;
            color: white;
        }
        .best-score {
            font-size: 0.9rem;
            color: #FF9800;
            font-weight: bold;
            text-align: right;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="../js/achievements.js"></script>
    <script src="../js/game-robot.js"></script>
</head>
<body>

    <div class="top-bar">
        <a href="../index.html" class="btn-back">‚Üê</a>
        <div>
            <div class="game-info" id="timer">00.00</div>
            <div class="best-score" id="best-score">üèÜ --:--</div>
        </div>
    </div>

    <div class="screen">
        <div class="target-display">
            –ò—â–∏ —á–∏—Å–ª–æ: <span id="target-num" class="target-number">1</span>
        </div>
        <div id="grid" class="schulte-grid size-5"></div>
        <div class="controls">
            <button class="btn-mode" id="mode-3" onclick="setMode(3)">3x3</button>
            <button class="btn-mode active" id="mode-5" onclick="setMode(5)">5x5</button>
            <button class="btn-mode btn-restart" onclick="restartGame()">‚Üª</button>
        </div>
    </div>

    <script>
        let currentGridSize = 5;
        let currentTarget = 1;
        let timerInterval;
        let isPlaying = false;
        let correctStreak = 0;

        const gridElement = document.getElementById('grid');
        const targetElement = document.getElementById('target-num');
        const timerElement = document.getElementById('timer');
        const bestScoreElement = document.getElementById('best-score');

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            } 
            else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            } 
            else if (type === 'win') {
                [440, 554, 659].forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                    o.start(audioCtx.currentTime + i * 0.1);
                    o.stop(audioCtx.currentTime + 1.5 + i * 0.1);
                });
            }
        }

        function setMode(size) {
            currentGridSize = size;
            document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mode-${size}`).classList.add('active');
            gridElement.className = `schulte-grid size-${size}`;
            updateBestScoreDisplay();
            restartGame();
        }

        function updateBestScoreDisplay() {
            const key = `schulte_best_${currentGridSize}`;
            const best = localStorage.getItem(key);
            if (best) {
                bestScoreElement.innerText = `üèÜ ${best}—Å`;
            } else {
                bestScoreElement.innerText = `üèÜ --:--`;
            }
        }

        function restartGame() {
            isPlaying = true;
            currentTarget = 1;
            correctStreak = 0;
            targetElement.innerText = "1";
            timerElement.innerText = "00.00";
            
            if (window.gameRobot) window.gameRobot.onGameStart();
            
            clearInterval(timerInterval);
            let startTime = Date.now();
            timerInterval = setInterval(() => {
                let delta = (Date.now() - startTime) / 1000;
                timerElement.innerText = delta.toFixed(2);
            }, 50);

            renderGrid();
        }

        function renderGrid() {
            gridElement.innerHTML = '';
            const count = currentGridSize * currentGridSize;
            let numbers = [];
            for (let i = 1; i <= count; i++) {
                numbers.push(i);
            }
            numbers.sort(() => Math.random() - 0.5);

            numbers.forEach(num => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = num;
                cell.style.fontSize = currentGridSize === 3 ? '3rem' : '2rem';
                cell.onpointerdown = (e) => {
                    e.preventDefault();
                    handleCellClick(cell, num, count);
                };
                gridElement.appendChild(cell);
            });
        }

        function handleCellClick(cell, number, maxNumber) {
            if (!isPlaying) return;

            if (number === currentTarget) {
                playSound('click');
                cell.classList.add('correct-anim');
                correctStreak++;
                
                if (window.gameRobot) {
                    if (correctStreak % 5 === 0 && correctStreak > 0) {
                        window.gameRobot.onCombo(correctStreak);
                    } else if (Math.random() < 0.3) {
                        window.gameRobot.onCorrect();
                    }
                }
                
                currentTarget++;

                if (currentTarget > maxNumber) {
                    gameWin();
                } else {
                    targetElement.innerText = currentTarget;
                }
            } else {
                playSound('error');
                correctStreak = 0;
                cell.style.backgroundColor = '#FF5252';
                cell.style.color = 'white';
                if (window.gameRobot && Math.random() < 0.5) {
                    window.gameRobot.onWrong();
                }
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                    cell.style.color = '';
                }, 300);
            }
        }

        function gameWin() {
            isPlaying = false;
            clearInterval(timerInterval);
            playSound('win');
            confetti();

            const finalTime = parseFloat(timerElement.innerText);
            let reward = 15;
            saveCoins(reward);
            
            updateGameStats(finalTime);
            
            const key = `schulte_best_${currentGridSize}`;
            const oldRecord = parseFloat(localStorage.getItem(key)) || 9999;
            const isNewRecord = finalTime < oldRecord;
            
            if (isNewRecord) {
                localStorage.setItem(key, finalTime);
                if (window.gameRobot) window.gameRobot.onNewRecord();
            } else {
                if (window.gameRobot) window.gameRobot.onGameOver();
            }
            
            checkRecord(finalTime, reward, isNewRecord);
        }

        function updateGameStats(time) {
            let totalGames = parseInt(localStorage.getItem('neuroTotalGames')) || 0;
            localStorage.setItem('neuroTotalGames', totalGames + 1);
            
            let schultePlayed = parseInt(localStorage.getItem('neuroSchultePlayed')) || 0;
            localStorage.setItem('neuroSchultePlayed', schultePlayed + 1);
            
            let bestTime = parseFloat(localStorage.getItem('neuroSchulteBestTime')) || 9999;
            if (time < bestTime) {
                localStorage.setItem('neuroSchulteBestTime', time);
            }
            
            if (window.AchievementsSystem) {
                const newAchievements = window.AchievementsSystem.check();
                newAchievements.forEach(ach => {
                    setTimeout(() => window.AchievementsSystem.showNotification(ach), 1000);
                });
            }
        }

        function checkRecord(time, reward, isNewRecord) {
            updateBestScoreDisplay();
            
            setTimeout(() => {
                let msg = `–ü–æ–±–µ–¥–∞! –í—Ä–µ–º—è: ${time} —Å\n–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${reward} –º–æ–Ω–µ—Ç! üí∞`;
                
                if (isNewRecord) {
                    msg += `\nüéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!`;
                }
                
                alert(msg);
            }, 800);
        }

        function saveCoins(amount) {
            let currentBank = parseInt(localStorage.getItem('neuroCoins')) || 0;
            localStorage.setItem('neuroCoins', currentBank + amount);
            
            let totalEarned = parseInt(localStorage.getItem('neuroTotalCoinsEarned')) || 0;
            localStorage.setItem('neuroTotalCoinsEarned', totalEarned + amount);
        }

        document.body.addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });

        document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });

        updateBestScoreDisplay();
        restartGame();
    </script>
</body>
</html>
